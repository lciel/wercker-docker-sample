box: wercker-labs/docker
build:
  steps:
    - script:
        name: Load image caches
        code: |
          ls $WERCKER_CACHE_DIR
          echo $WERCKER_CACHE_DIR
          if [ -e $WERCKER_CACHE_DIR/base.tar ]; then sudo docker load < $WERCKER_CACHE_DIR/base.tar; fi
          if [ -e $WERCKER_CACHE_DIR/webapp.tar ]; then sudo docker load < $WERCKER_CACHE_DIR/webapp.tar; fi
    - script:
        name: Build base image
        code: |
          sudo docker build -t 127.0.0.1:49000/lciel/base ./base
    - script:
        name: Build webapp image
        code: |
          sudo docker build -t 127.0.0.1:49000/lciel/webapp ./webapp
    - script:
        name: List images
        code: |
          sudo docker images
    - script:
        name: Save image caches
        code: |
          sudo docker save 127.0.0.1:49000/lciel/base > $WERCKER_CACHE_DIR/base.tar
          sudo docker save 127.0.0.1:49000/lciel/webapp > $WERCKER_CACHE_DIR/webapp.tar
    - script:
        name: Run rspec
        code: |
          sudo docker run --rm -e RAILS_ENV=test 127.0.0.1:49000/lciel/webapp:latest bash -c "cd /app && bundle exec rspec"
